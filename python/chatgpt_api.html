<!DOCTYPE html>
<html lang="ja">
<head>
<link rel="canonical" href="https://okumuralab.org/~okumura/python/chatgpt_api.html">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ChatGPTのAPIを使う</title>
<link rel="stylesheet" href="style.css">
<link rel="license" href="https://creativecommons.org/licenses/by/4.0/">
</head>
<body>

<nav id="breadcrumbs">
<a href="../">ホーム</a> &gt;
<a href="./">Python</a> &gt;
</nav>

<h1>ChatGPTのAPIを使う</h1>

<h2>はじめに</h2>

<p>従来のOpenAIのAPIについては<a href="openai_api.html">OpenAIのAPIを使う</a>で解説しています。</p>

<p>2023年3月2日（米国時間では1日）、<a href="https://openai.com">OpenAI</a> の <a href="https://openai.com/blog/chatgpt/">ChatGPT</a> の <a href="https://platform.openai.com">API</a> が公開されました（<a href="https://openai.com/blog/introducing-chatgpt-and-whisper-apis">Introducing ChatGPT and Whisper APIs</a>）。費用は従来の text-davinci-003 の1/10の0.0002ドル/1000トークンと、非常にお値打ちです。</p>

<p>従来のAPIを使っていた人は何もせずに使えますが、そうでない場合は、まず<a href="https://platform.openai.com/signup/">こちら</a>で登録してAPIキーを発行してもらわなければなりません。</p>

<p>APIの概要はOpenAIの <a href="https://platform.openai.com/docs/guides/chat/introduction">Introduction</a> および <a href="https://platform.openai.com/docs/api-reference/chat">Chat</a> をご覧ください。規約については <a href="https://platform.openai.com/docs/data-usage-policies">API data usage policies</a> をご覧ください。APIで送られたデータは学習用に使われることはありません。不正使用の監視のために30日間保持され、特に問題なければ消去されるようです。</p>

<h2>使い方の基本</h2>

<p>Pythonのパッケージは <code>pip install openai</code> でインストールできます。</p>

<p>APIキーは、プログラムに直接書き込まず、環境変数に設定しておくのが安全・便利です。MacやLinuxでは、ターミナルに</p>

<pre>
export OPENAI_API_KEY="sk-XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
</pre>

<p>と打ち込めば環境変数が設定されます。<code>.bashrc</code> 等に書き込んでおけばシェル起動時に設定されます。APIキーを書き込んだファイルは他人に見られないようにパーミッションを正しく設定しておきましょう。</p>

<p>使い方の基本は次の通りです：</p>

<pre>
import openai

res = openai.ChatCompletion.create(
    model="gpt-3.5-turbo",
    messages=[
        {"role": "system", "content": "あなたは賢いAIです。"},  # 役割設定（省略可）
        {"role": "user", "content": "1たす1は？"}               # 最初の質問
    ],
    temperature=1  # 温度（0-2, デフォルト1）
)

print(res["choices"][0]["message"]["content"])  # 答えが返る
</pre>

<p>ChatGPTのAPIは、質問・応答の履歴を記憶しません。以前の質問・応答を前提としたい場合は、次のように履歴を与えた上で質問をします：</p>

<pre>
res = openai.ChatCompletion.create(
    model="gpt-3.5-turbo",
    messages=[
        {"role": "system", "content": "あなたは賢いAIです。"},  # 役割設定（省略可）
        {"role": "user", "content": "1たす1は？"},              # 最初の質問
        {"role": "assistant", "content": "2です。"},            # 最初の答え
        {"role": "user", "content": "それを3倍して。"}          # 次の質問
    ],
    temperature=1
)

print(res["choices"][0]["message"]["content"])  # 答えが返る
</pre>

<p>履歴と質問、答えを合わせて、4096トークンが上限です。トークンはほぼ単語に相当するものです（後述）。トークン数を表示するには、次のようにします：</p>

<pre>
print(res["usage"]["prompt_tokens"],      # （履歴と）質問のトークン数
      res["usage"]["completion_tokens"],  # 答えのトークン数
      res["usage"]["total_tokens"])       # 合計
</pre>

<p>合計が4096を超えることはありません。延々と会話を続けるには、不要な履歴を削除する必要があります。削除も含めて、簡単な会話を続けるには、例えば次のようにすればいいでしょう：</p>

<pre>
import openai

msg = [{"role": "system", "content": "あなたは賢いAIです。"}]
while True:
    prompt = input("> ").strip()
    if prompt in ["quit", "exit"]:
        break
    msg.append({"role": "user", "content": prompt})
    res = openai.ChatCompletion.create(model="gpt-3.5-turbo", messages=msg)
    ans = res["choices"][0]["message"]["content"].strip()
    print(ans)
    msg.append({"role": "assistant", "content": ans})
    if res["usage"]["total_tokens"] > 3000:
        msg.pop(1)
        msg.pop(1)
</pre>

<h2>トークン</h2>

<p>トークンはほぼ単語に相当する概念で、ChatGPTでは <a href="https://github.com/openai/tiktoken">tiktoken</a> の cl100k_base というエンコーディングが使われているようです。頻出単語は1トークン、そうでない単語は2トークン以上に分割されます。日本語の場合は、2〜3文字が1トークンになることも、逆に1文字が2〜3トークンに分割されることもあります。</p>

<p><code>pip install tiktoken</code> して試してみましょう：</p>

<pre>
import tiktoken

enc = tiktoken.get_encoding("cl100k_base")
</pre>

<p>次の例で試してみましょう（山本義隆『熱学思想の史的展開』（現代数学社，1987年）より）：</p>

<pre style="white-space: pre-wrap">
s = "「何人ものニュートンがいた（There were several Newtons）」と言ったのは，科学史家ハイルブロンである．同様にコーヘンは「ニュートンはつねに二つの貌を持っていた（Newton was always ambivalent）」と語っている．"
</pre>

<pre>
e = enc.encode(s)
for i in e:
    c = enc.decode([i])
    if len(c) == 1 and ord(c) == 65533:  # 65533は「�」
        print(i, end="|")
    else:
        print(c, end="|")
print()
</pre>

<p>次のように88トークンに分割されていることがわかります：</p>

<blockquote>
「|何|人|も|の|ニ|ュ|ート|ン|が|い|た|（|There| were| several| Newton|s|）|」|と|言|っ|た|の|は|，|科|学|5877|110|家|2845|237|イ|ル|ブ|ロ|ン|で|あ|る|．|同|162|100|246|に|コ|ー�|246|ン|は|「|ニ|ュ|ート|ン|は|つ|2243|255|に|二|つ|の|80631|234|を|持|って|い|た|（|Newton| was| always| amb|ivalent|）|」|と|45918|252|って|い|る|．|
</blockquote>

<p>英語はだいたい1語1トークンですが、直前のスペースも含めてトークンになっていることがけっこうあります。日本語はだいたい1文字1トークンですが、「様」のようにUTF-8の3バイトがそれぞれトークンになっている場合や、「ーヘ」の「ヘ」の最初の2バイトが「ー」とくっついて1トークンになっているような場合もあります。</p>

<p>ちなみに、同じ文字列をOpenAIの <a href="https://platform.openai.com/tokenizer">Tokenizer</a> に入れると、GPT-3では120トークンになります。</p>

<hr>

<footer>
<p><a href="../" rel="author">奥村 晴彦</a></p>
<p>Last modified: <time>2023-03-08 20:07:46 JST</time></p>
</footer>
</body>
</html>
