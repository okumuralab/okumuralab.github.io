<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<title>COVID-19 番外編1</title>
<link rel="stylesheet" href="style.css">
<link rel="license" href="http://creativecommons.org/licenses/by/4.0/">
</head>
<body>

<nav id="breadcrumbs">
<a href="/~okumura/">ホーム</a> &gt;
<a href="./">Python</a> &gt;
</nav>

<h1>COVID-19 番外編1</h1>

<p><a href="COVID-19.html">COVID-19</a> の番外編。</p>

<p>WHO の日報 <a href="https://www.who.int/emergencies/diseases/novel-coronavirus-2019/situation-reports/">Coronavirus disease (COVID-2019) situation reports</a> から最新のもの（ここでは 20200311-sitrep-51-covid-19.pdf）をいただいてきて，まずテキスト化する（これはシェルのコマンド。全部 Python で行う方法は後述）：</p>

<pre><code>pdftotext -raw 20200311-sitrep-51-covid-19.pdf</code></pre>

<p>できた 20200311-sitrep-51-covid-19.txt を読んで，横軸が Confirmed（確定数），縦軸が Deaths（死者数）の両対数グラフを描く。試行錯誤しながらなので，きれいなコードではない：</p>

<pre><code>import matplotlib.pyplot as plt
import pandas as pd
import re
import numpy as np

dic = {
    'Republic of)': 'Iran',
    'Emirates': 'Arab',
    'territory': 'Palestine',
    'America': 'US',
    'Republic of Korea': 'Korea',
    'The United Kingdom': 'UK',
    'conveyance': '(Diamond Princess)'
}

countries = []
confirmed = []
death = []

prev = ''
with open("20200311-sitrep-51-covid-19.txt") as f:
    for line in f:
        line = line.strip()
        m = re.search(r'^Total +(\d+) +(\d+) +(\d+) +(\d+) +(\d+) +(\d+)$', line)
        if m:
            countries.append('China')
            confirmed.append(int(m[5]))
            death.append(int(m[6]))
        m = re.search(r'^([^\d]+)?(\d+) +(\d+) +(\d+) +(\d+) +(Local transmission|Imported cases only|Under investigation) +(\d+)$', line)
        if m:
            if m[1]:
                country = m[1].strip()
            else:
                country = prev
            if country in dic:
                country = dic[country]
            countries.append(country)
            confirmed.append(int(m[2]))
            death.append(int(m[4]))
        prev = line

countries = np.array(countries)
confirmed = np.array(confirmed)
death = np.array(death)

plt.figure(figsize=[6.4, 6.4])

plt.plot(confirmed[death > 1], death[death > 1], 'o')
plt.xscale('log')
plt.yscale('log')
plt.axis('equal')

for x in zip(confirmed[death > 1], death[death > 1], countries[death > 1]):
    if len(x[2]) == 2 or len(x[2]) == 5:
        plt.text(x[0], x[1], x[2], horizontalalignment='right', verticalalignment='top')
    else:
        plt.text(x[0], x[1], x[2], horizontalalignment='left', verticalalignment='bottom')

plt.xlabel('Confirmed')
plt.ylabel('Deaths')

x = np.array([min(confirmed[death > 1]), max(confirmed[death > 1])])
y = x * death[0] / confirmed[0]

plt.plot(x, y, color='lightgray')
</code></pre>

<p>pdftotext コマンドを直接使わずすべて Python で行うには，まず pip で <a href="https://pypi.org/project/pdftotext/">pdftotext</a> ライブラリをインストールする。Mac なら</p>

<pre><code>brew install pkg-config poppler
pip install pdftotext
</code></pre>

<p>こうしてから，<code>import pdftotext</code> し，上記コードの <code>with</code> で始まる2行を次のようにする：</p>

<pre><code>with open("20200311-sitrep-51-covid-19.pdf", "rb") as f:
    for line in "".join(pdftotext.PDF(f)).split("\n"):
</code></pre>

<p>pdftotext の -raw に相当するオプションがうまく扱えないので多少テキスト出力が変わる。上記コードはこの違いを吸収するように書いてある。</p>

<p>中国と日本の履歴を書き込む：</p>

<pre><code>plt.autoscale(False)

df = pd.read_csv("https://oku.edu.mie-u.ac.jp/~okumura/python/data/COVID-19.csv",
                 index_col='Date', parse_dates=['Date'])
plt.plot(df['China Confirmed'], df['China Deaths'], 'x-')

df = pd.read_csv("https://oku.edu.mie-u.ac.jp/~okumura/python/data/COVID-jp.csv",
                 index_col='Date', parse_dates=['Date'])
plt.plot(df['Confirmed'], df['Deaths'], 'x-')

plt.savefig('COVID-world.svg', bbox_inches="tight")
</code></pre>

<figure><img src="img/COVID-world.svg" alt="COVID-19"></figure>

<p>（↑最新のデータに更新）</p>

<hr>

<p>全部の国の推移を見たいのだが，いちいち上のようにして WHO のサイトの PDF から抜き出すのはたいへんなので，<a href="https://gisanddata.maps.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6">Coronavirus COVID-19 Global Cases by Johns Hopkins CSSE</a> という有名なサイトのデータレポじとり <a href="https://github.com/CSSEGISandData/COVID-19">2019 Novel Coronavirus COVID-19 (2019-nCoV) Data Repository by Johns Hopkins CSSE</a> から時系列データ csse_covid_19_time_series/time_series_covid19_confirmed_global.csv をいただいてきて，そのまま描く：</p>

<pre><code>import matplotlib.pyplot as plt
import matplotlib.dates as mdates
import pandas as pd
from dateutil.parser import parse

df = pd.read_csv('time_series_covid19_confirmed_global.csv')

t = [parse(i) for i in df.columns[4:]]
x = [df.groupby('Country/Region')[i].sum() for i in df.columns[4:]]

locator = mdates.AutoDateLocator()
formatter = mdates.ConciseDateFormatter(locator)

fig, ax = plt.subplots()
ax.xaxis.set_major_locator(locator)
ax.xaxis.set_major_formatter(formatter)
ax.plot(t, x)
ax.set_yscale('log')

for i in x[-1].index:
    if x[-1][i] > 0:
        ax.text(t[-1], x[-1][i], i)

japan = [x[i]['Japan'] for i in range(len(x))]
ax.plot(t, japan, 'o-k')

fig.savefig('COVID-csse.svg', bbox_inches="tight")
</code></pre>

<p>黒で黒丸マーカーを付けたものが日本である。データは WHO のものと微妙に異なり，日本については累積確認数の減少が2箇所ある。</p>

<figure><img src="img/COVID-csse.svg" alt="COVID-19"></figure>

<p><a href="../" rel="author">奥村 晴彦</a></p>

<p>
<!-- hhmts start -->
Last modified: <time>2020-03-25 13:44:45</time>
<!-- hhmts end -->
</p>
</body>
</html>
