<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<title>M1 Mac</title>
<link rel="stylesheet" href="/~okumura/style6.css">
<link rel="license" href="http://creativecommons.org/licenses/by/4.0/">
</head>
<body>

<nav id="breadcrumbs" itemprop="breadcrumb">
<a href="../" rel="home">ホーム</a> &gt;
<a href="./">macOS</a> &gt;
</nav>

<h1>M1 Mac</h1>

<p><em>[TL;DR]</em> Rosetta で x86_64 バイナリを使えば問題ない。それでも Intel より速い。arm64 ネイティブなバイナリは今のところ Apple 製のものや TeX など一部に限られる。ソースからのコンパイルはけっこうたいへん。</p>

<h3>前口上</h3>

<p>2020-11-13 に Apple Store で注文した MacBook Air 16G/256G が 2020-11-29 に届いたのでさっそく設定。</p>

<h3>セットアップと一般的な設定</h3>

<p>他の Mac からコピーという手もあったが，ここはクリーンセットアップすることにする。Apple ID を設定したら iCloud から多くの設定を拾ってくれたので，たいした手間ではない。アカウント名（ホームディレクトリ名）が okumuraharuhiko になったので okumura に直す。</p>

<p>買ったばかりの OS は無名 11 であったので，システム環境設定→ソフトウェアアップデートで 11.0.1 にアップデート。</p>

<p>コンピュータ名が長ったらしいものになったのでシステム環境設定の「共有」で直す。</p>

<p>Finder の環境設定→詳細で「すべてのファイル名拡張子を表示」をオンにする。</p>

<p>メール設定では，表示→「メッセージ内のリモートコンテンツを読み込む」をオフに，作成→メッセージのフォーマットを「標準テキスト」に。</p>

<p>システム環境設定でキーボード→ショートカット→入力ソースのショートカットは Emacs に有害なので外す。</p>

<p>コントロールセンターでキーボードの輝度をゼロに。</p>

<p>システム環境設定でディスプレイを1日中 Night Shift に設定する。色温度は好みに。</p>

<div class="note">
<p>以上以外に，私は非常に慎重を期すためにいつも自分を管理者から外している。具体的には，システム環境設定の「ユーザとグループ」で自分（奥村）以外に管理者（名前は例えば admin とする）を一人作成し，その管理者（Apple ID には紐付けない）でログインし直して奥村を一般ユーザに格下げする。これで何か重要なことをする際には管理者の名前とパスワードを聞いてくるのでうっかり危ないコマンドを実行する危険性が減る。Unix 的には sudoers から外したことに相当する。コマンドでシステム領域に触れたいときは <code>su admin</code> してから <code>sudo 何々</code> する。ただ，macOS はデフォルトでずいぶん安全になったので，今はここまでする必要はないかもしれない。</p>
</div>

<h3>ターミナル</h3>

<p>ターミナルを開き，試しに <code>uname -m</code> と打ち込むと arm64 と表示される。いったんターミナルを閉じて，Finder でターミナルを選択して「情報を見る」で「Rosettaを使用して開く」にチェックを付けると Rosetta がインストールされる（一般には任意の x86_64 なアプリを最初に起動したときに Rosetta がインストールされるのであろう）。Rosetta で開かれたターミナルに <code>uname -m</code> と打ち込むと x86_64 と表示される。今度は「Rosettaを使用して開く」をオフにしてターミナルを開き直して <code>uname -m</code> するとまた arm64 になるが，Rosetta がインストールされたので</p>

<pre>
arch -x86_64 uname -m
</pre>

<p>と打ち込むと x86_64 になる（Rosetta がない状態ではこのコマンドは Bad CPU type in executable エラーになる）。このようにちょっとしたコマンドなら <code>arch -x86_64</code> を冠することにより Rosetta で実行できるが，まとまったことをするには</p>

<pre>
arch -x86_64 zsh
</pre>

<p>とすれば Rosetta で zsh が立ち上がる。この状態で Homebrew の Intel 版のインストールに進めばよい。</p>

<h3>シェル</h3>

<p>今まで bash を使っていたが，クリーンセットアップしたので zsh になった。とりあえずプロンプトを見やすくするために <code>~/.zshrc</code> に <code>PROMPT='%m:%~%# '</code> と書き込む。あるいは Rosetta 状態かどうかをプロンプトに含めてもよい：</p>

<pre>
ARCH=`uname -m`
PROMPT="${ARCH} %m:%~%# "
</pre>

<p>あるいは場合分けもできる：</p>

<pre>
ARCH=`uname -m`
if [[ $ARCH == 'arm64' ]]; then
    PROMPT="[a] %m:%~%# "
    export PATH=/opt/homebrew/bin:$PATH
else
    PROMPT="[x] %m:%~%# "
fi
</pre>

<p>環境変数は <code>~/.zshenv</code> で設定するが，<code>setopt no_global_rcs</code> と書いておかないと PATH を上書きされてしまう。</p>

<pre>
setopt no_global_rcs
export PATH=... # bashと同様
</pre>

<h3>Command Line Tools</h3>

<p>コマンドラインで開発する場合，巨大な Xcode をインストールする必要はない。コマンドライン用の開発ツールは，何らかの開発用コマンド（gcc とか python3 とか）を実行しようとするとインストールを促される。より確実な方法は，ターミナルに <code>xcode-select --install</code> と打ち込むか，<a href="https://developer.apple.com/downloads">https://developer.apple.com/downloads</a> からダウンロードしてインストールする。</p>

<h3>Homebrew</h3>

<p>MacPorts のほうが M1 対応が進んでいるが，他のマシンに合わせて Homebrew を入れた。とりあえずは Intel 版で間に合わせる。通常通り <a href="https://brew.sh">Homebrew</a> の最初に書いてあるコマンドを <code>uname -m</code> が x86_64 なターミナルに打ち込めばインストールできる。</p>

<p>ARM 版については Homebrew の <a href="https://docs.brew.sh/Installation">Installation</a> 参照。対応状況は <a href="https://github.com/Homebrew/brew/issues/7857">macOS 11 Big Sur compatibility on Apple Silicon #7857</a> にまとめられている。@yujiod さんの <a href="https://qiita.com/yujiod/items/56002a7cef5b5a3be3fb">Apple SiliconにおけるHomebrewのベストプラクティス</a> も参考になる。<code>/opt/homebrew</code>（ユーザ権限で書き込めるようにしておく）にインストールする。</p>

<pre>
cd /opt
curl -L https://github.com/Homebrew/brew/tarball/master | tar xz --strip 1 -C homebrew
</pre>

<h3>Emacs 27</h3>

<p>arm64 環境でビルドしてみたがエラー。Rosetta 環境でなら簡単にできた。</p>

<h3>Python</h3>

<p>Apple のコマンドラインツールに入っている /usr/bin/python3 は universal binary な 3.8.2 である：</p>

<pre>
% file /usr/bin/python3
/usr/bin/python3: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64] [arm64e:Mach-O 64-bit executable arm64e]
/usr/bin/python3 (for architecture x86_64):	Mach-O 64-bit executable x86_64
/usr/bin/python3 (for architecture arm64e):	Mach-O 64-bit executable arm64e
</pre>

<p>これに Apple から提供されている <a href="https://github.com/apple/tensorflow_macos">tensorflow_macos</a> を入れれば TensorFlow とその依存するパッケージ群（numpy など）が入る。bash で ~/tensorflow_macos_venv に入って <code>source bin/activate</code> すると使えるようになり，<code>deactivate</code> で戻る。matplotlib や pandas は入らない。pip で入れようとしてもコンパイルでエラーになる。</p>

<p>pip で簡単にパッケージを入れるためには今のところ Rosetta で python.org のものか Homebrew のものを使うほうが楽である。しかも 3.9 ではなく 3.8.x が楽である。</p>

<h3>R</h3>

<p><a href="https://developer.r-project.org/Blog/public/2020/11/02/will-r-work-on-apple-silicon/">Will R Work on Apple Silicon?</a> まずは Fortran 90 compiler が必要とのこと。</p>

<h3>TeX</h3>

<p>Rosetta で使っても十分速いが，native なコードを使いたければ，MacTeX の <a href="http://www.tug.org/mactex/aboutarm.html">About Arm</a> のページから <a href="http://www.tug.org/mactex/MacTeX-2020-Universal.pkg">MacTeX-2020-Universal.pkg</a> をダウンロードして展開して得られるバイナリで TeX Live 2020 のバイナリを置き換えればよい。例えば TeX Live 2020 が /usr/local/texlive/2020 にインストールされているなら次のようにすればよい。</p>

<pre>
pkgutil --expand MacTeX-2020-Universal.pkg /tmp/hoge
pax -rz -f /tmp/hoge/MacTeX-2020-Universal-Start.pkg/Payload
mv usr/local/texlive/2020/bin/custom /usr/local/texlive/2020/bin/
</pre>

<p>これで /usr/local/texlive/2020/bin/custom にパスを通す。</p>

<p>lualatex で188ページの原稿をコンパイルする時間（数回のうち最小値）：

<ul>
  <li>MacBook Air (M1, 2020) 16GB Rosetta 11.52秒 arm64 8.63秒</li>
  <li>Mac mini (2018) 16GB 16.221秒</li>
  <li>MacBook Air (11-inch, Early 2015) 8GB 21.614秒</li>
  <li>Mac mini (Late 2014) 8GB 22.514秒</li>
</ul>

<h2>参考</h2>

<ul>
  <li>@shibukawa さんの <a href="https://qiita.com/shibukawa/items/797b7cbb7e530842e6f7">M1 Macの開発環境</a></li>
  <li>iori さんの <a href="https://zenn.dev/ioridev/articles/c74af379e4e73151790d">個人的 M1 mac 開発環境状況</a></li>
</ul>

<hr>

<footer>
<p><a href="../" rel="author">奥村 晴彦</a></p>

<p>
<!-- hhmts start -->
Last modified: <time>2020-12-09 12:31:52</time>
<!-- hhmts end -->
</p>
</footer>
</body>
</html>
