<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<title>M1 Mac</title>
<link rel="stylesheet" href="../style.css">
<link rel="license" href="https://creativecommons.org/licenses/by/4.0/">
</head>
<body>

<nav id="breadcrumbs" itemprop="breadcrumb">
<a href="../" rel="home">ホーム</a> &gt;
<a href="./">macOS</a> &gt;
</nav>

<h1>M1 Mac</h1>

<h3>はじめに</h3>

<p>2020-11-13 に Apple Store で注文した MacBook Air 16G/256G が 2020-11-29 に届いたのでさっそく設定。</p>

<p>2020-11-20 に生協に注文した Mac mini 16G/256G は 2021-01-12 に届いた。</p>

<p>どちらもメモリ16Gにしたが，通常の用途には8Gで十分かも。SSDは満タンの半分程度で使うつもりで選ぶほうが安心らしいので，据置き用には外付けHDDをAPFSフォーマットして使う。</p>

<h3>セットアップと一般的な設定</h3>

<p>他の Mac からコピーという手もあったが，ここはクリーンセットアップすることにする。Apple ID を設定したら iCloud から多くの設定を拾ってくれたので，たいした手間ではない。セットアップ中に「コンピュータアカウントを作成」でサジェストされるアカウント名（私の場合は okumuraharuhiko だった）は，普段使っているユーザ名（私の場合 okumura）に直す（後でも直せる）。</p>

<p>まずは「システム環境設定」→「ソフトウェアアップデート」でOSをアップデート。「セキュリティとプライバシー」で FileVault（暗号化）をオンにする。ドライブを暗号化しておけば，盗まれても安心だし，廃棄する際にも鍵を捨てるだけで復号不能になる。パフォーマンス低下は無視できるはず。</p>

<p>コンピュータ名が長ったらしいものになったのでシステム環境設定の「共有」で直す。ついでに「リモートログイン」を許可しておく（ssh でログインするため）。いずれにしてもパスワードは十分複雑なものにしておく。ちなみにパスワードは大文字小文字数字記号を混在させる必要はない。その分，長くすれば，問題ない。</p>

<p>Finder の環境設定→詳細で「すべてのファイル名拡張子を表示」をオンにする。Safari の環境設定「一般」で「ダウンロード後、“安全な”ファイルを開く」をオフにする。</p>

<p>メール設定では，表示→「メッセージ内のリモートコンテンツを読み込む」をオフに，作成→メッセージのフォーマットを「標準テキスト」に。</p>

<p>システム環境設定でキーボード→ショートカット→入力ソースのショートカットは Emacs に有害なので外す。キーボード→音声入力はデフォルトではControlキーを2回だが，これもControlキーを多用すると間違いやすいので，これ以外（例えばFnを2回）にする。ついでにキーリピートを最速にする（<a href="https://apple.stackexchange.com/questions/10467/how-to-increase-keyboard-key-repeat-rate-on-os-x">爆速にする方法</a>もある）。</p>

<p>コントロールセンターでキーボードの輝度をゼロに（MacBook Air）。</p>

<p>「システム環境設定」→「ディスプレイ」で正しい解像度が選べない場合は Option キーを押しながら「変更」をクリック（→ <a href="https://www.eizo.co.jp/support/compati/pc/mac/apple-m1/">Apple M1チップ搭載MacとEIZOモニターの互換性</a>）。</p>

<p>（これは好みだが）システム環境設定でディスプレイの色温度を自分好みに設定する。あるいは1日中 Night Shift に設定するのが簡単。</p>

<div class="note">
<p>以上以外に，私は非常に慎重を期すためにいつも自分を管理者から外している。具体的には，システム環境設定の「ユーザとグループ」で自分（奥村）以外に管理者（名前は例えば admin とする）を一人作成し，その管理者（Apple ID には紐付けない）でログインし直して奥村を一般ユーザに格下げする。これで何か重要なことをする際には管理者の名前とパスワードを聞いてくるのでうっかり危ないコマンドを実行する危険性が減る。Unix 的には sudoers から外したことに相当する。コマンドでシステム領域に触れたいときは <code>su admin</code> してから <code>sudo 何々</code> する。ただ，macOS はデフォルトでずいぶん安全になったので，今はここまでする必要はないかもしれない。</p>
</div>

<p>初期の M1 Mac にあった問題（おそらく Big Sur 11.2 で改善されたはず）：</p>

<ul>
  <li>Bluetooth の接続がよく切れる</li>
  <li>スクリーンセーバー解除ができなくなる（他マシンからログインして ScreenSaverEngine を kill すればよい）</li>
  <li>Big Sur 11.2 になっても iPhone から M1 MacBook Air への Bluetooth テザリングがうまくいかない（M1 Mac mini ならできるので理由がわからない）。</li>
</ul>

<h3>ターミナル</h3>

<p>ターミナルを開き，試しに <code>uname -m</code> と打ち込むと arm64 と表示される。いったんターミナルを閉じて，Finder でターミナルを選択して「情報を見る」で「Rosettaを使用して開く」にチェックを付けると Rosetta がインストールされる（一般には任意の x86_64 なアプリを最初に起動したときに Rosetta がインストールされるのであろう）。Rosetta で開かれたターミナルに <code>uname -m</code> と打ち込むと x86_64 と表示される。今度は「Rosettaを使用して開く」をオフにしてターミナルを開き直して <code>uname -m</code> するとまた arm64 になるが，Rosetta がインストールされたので</p>

<pre>
arch -x86_64 uname -m
</pre>

<p>と打ち込むと x86_64 になる（Rosetta がない状態ではこのコマンドは Bad CPU type in executable エラーになる）。このようにちょっとしたコマンドなら <code>arch -x86_64</code> を冠することにより Rosetta で実行できるが，まとまったことをするには</p>

<pre>
arch -x86_64 zsh
</pre>

<p>とすれば Rosetta で zsh が立ち上がる。x86_64 のコードを実行するにはこの状態で行う。.zshrc に <code>alias x86='arch -x86_64 zsh'</code> のようにエイリアスを作っておけば <code>x86</code> と入力するだけでこの状態になる。</p>

<h3>シェル</h3>

<p>今まで bash を使っていたが，クリーンセットアップしたので zsh になった。とりあえずプロンプトを見やすくするために <code>~/.zshrc</code> に <code>PROMPT='%m:%~%# '</code> と書き込む。あるいは Rosetta 状態かどうかをプロンプトに含めてもよい：</p>

<pre>
ARCH=`uname -m`
PROMPT="${ARCH} %m:%~%# "
</pre>

<p>あるいは場合分けもできる：</p>

<pre>
ARCH=`uname -m`
if [[ $ARCH == 'arm64' ]]; then
    PROMPT="[a] %m:%~%# "
else
    PROMPT="[x] %m:%~%# "
fi
</pre>

<p>ほかに例えば次のようなオプションを設定しておく：</p>

<pre>
HISTFILE=~/.zsh_history
HISTSIZE=1000
SAVEHIST=1000
setopt HIST_VERIFY
setopt INC_APPEND_HISTORY
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_ALLOW_CLOBBER
setopt HIST_REDUCE_BLANKS
setopt HIST_IGNORE_SPACE
setopt NO_HIST_BEEP
setopt NO_CLOBBER
</pre>

<p>環境変数は <code>~/.zshenv</code> で設定するが，<code>NO_GLOBAL_RCS</code> オプションを指定しないと PATH を上書きされてしまう。</p>

<pre>
setopt NO_GLOBAL_RCS
export PATH=... # bashと同様
</pre>

<p>PATH は場合分けして設定できる。例えば</p>

<pre>
setopt NO_GLOBAL_RCS
ARCH=`uname -m`
PATH=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin
PATH=/Library/Frameworks/R.framework/Versions/4.0/Resources/bin:$PATH
if [[ $ARCH == 'arm64' ]]; then
    PATH=/usr/local/texlive/2020/bin/custom:$PATH
    PATH=/opt/homebrew/bin:/opt/homebrew/sbin:$PATH
    PATH=/opt/homebrew/Caskroom/miniforge/base/bin:$PATH
else
    PATH=/usr/local/texlive/2020/bin/x86_64-darwin:$PATH
    PATH=/Library/Frameworks/Python.framework/Versions/3.9/bin:$PATH
    PATH=/Users/okumura/Library/Python/3.9/bin:$PATH
fi
export PATH
</pre>

<h3>Command Line Tools</h3>

<p>コマンドラインで開発する場合，巨大な Xcode をインストールする必要はない。コマンドライン用の開発ツールは，何らかの開発用コマンド（gcc とか python3 とか）を実行しようとするとインストールを促される。より確実な方法は，ターミナルに <code>xcode-select --install</code> と打ち込むか，<a href="https://developer.apple.com/downloads">https://developer.apple.com/downloads</a> からダウンロードしてインストールする。OS を更新するとコマンドラインツールも再インストールが必要になることが多いので注意。</p>

<h3>Homebrew</h3>

<p><a href="https://brew.sh/2021/02/05/homebrew-3.0.0/">Homebrew 3.0.0</a>:
"Apple Silicon is now officially supported for installations in /opt/homebrew."</p>

<p>wget，gnupg，pinentry-mac，imagemagick，poppler，ffmpeg，graphviz など，大部分のものは Apple Silicon 版が用意されるようになった。pandoc はまだ Intel 版だけ。</p>

<p>ARM 版は，<a href="https://docs.brew.sh/Installation">Installation</a> にあるように <code>/opt/homebrew</code>（ユーザ権限で書き込めるようにしておく）にインストールする：</p>

<pre>
cd /opt
curl -L https://github.com/Homebrew/brew/tarball/master | tar xz --strip 1 -C homebrew
</pre>

<p>Rosetta で実行する Intel 版は通常通り <a href="https://brew.sh">Homebrew</a> の最初に書いてあるコマンドを <code>uname -m</code> が x86_64 なターミナルに打ち込めばインストールできる。</p>

<h3>Emacs 27</h3>

<p>ソースから arm64 環境でビルドしてみたがエラー。よくわからないが Rosetta 環境でなら簡単にビルドできるので，現在はそれを使っている。ビルドが面倒な場合には適当なバイナリを探してくる。</p>

<p>ARM 版 Homebrew で <code>brew install emacs</code> でインストールされる emacs はターミナル版。<code>brew install --cask emacs</code> でインストールされるものは <a href="https://emacsformacosx.com">Emacs for Mac OS X</a> のバイナリで M1 用ではないが Rosetta で動く。</p>

<h3>Python</h3>

<p>Apple のコマンドラインツールに入っている /usr/bin/python3 は universal binary な 3.8.2 である：</p>

<pre>
% file /usr/bin/python3
/usr/bin/python3: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64] [arm64e:Mach-O 64-bit executable arm64e]
/usr/bin/python3 (for architecture x86_64):	Mach-O 64-bit executable x86_64
/usr/bin/python3 (for architecture arm64e):	Mach-O 64-bit executable arm64e
% /usr/bin/python3 --version
Python 3.8.2
</pre>

<p>これに Apple から提供されている <a href="https://github.com/apple/tensorflow_macos">tensorflow_macos</a> を入れれば Apple Silicon に最適化された TensorFlow とその依存するパッケージ群（numpy など）が入る。TensorFlow Blog の <a href="https://blog.tensorflow.org/2020/11/accelerating-tensorflow-performance-on-mac.html">Accelerating TensorFlow Performance on Mac</a> 参照。<a href="https://docs.python.org/3/tutorial/venv.html">venv</a> なので，bash 互換シェル（zsh でもよい）で <code>source ~/tensorflow_macos_venv/bin/activate</code> すると使えるようになり，<code>deactivate</code> で戻る。matplotlib や pandas は入らない。pip で入れようとしてもコンパイルでエラーになる。強者用である。</p>

<p>本家 <a href="https://www.python.org">python.org</a> の Python が 3.9.1 から universal バイナリも experimental という括弧書きで提供されるようになった。ただし pip で簡単にパッケージを追加できる状況にないので，混乱しないためには通常の macOS 64-bit Intel installer でインストールし，Rosetta で使うのが簡単である。インストールすると zsh を使っている場合は <code>.zprofile</code> に PATH が追記されるので適宜修正する。</p>

<p>一方，<a href="https://github.com/conda-forge/miniforge">miniforge</a> を使えば主要ライブラリを含めて arm64 版がインストールできる（<a href="https://qiita.com/syoyo/items/6ad890c8a902d02d8c5a">こちら</a>参照）。うまくすれば Apple の TensorFlow と組み合わせることもできる（<a href="https://towardsdatascience.com/tensorflow-2-4-on-apple-silicon-m1-installation-under-conda-environment-ba6de962b3b8">TensorFlow 2.4 on Apple Silicon M1: installation under Conda environment</a> および <a href="https://towardsdatascience.com/benchmark-m1-vs-xeon-vs-core-i5-vs-k80-and-t4-e3802f27421c">Benchmark M1 vs Xeon vs Core i5 vs K80 and T4</a> 参照）。</p>

<p>miniforge は Homebrew で入れるのが簡単。<code>/opt/homebrew/bin/brew install miniforge</code> とすればよい。/opt/homebrew/Caskroom/miniforge 以下に入るので /opt/homebrew/Caskroom/miniforge/base/bin をPATHに加える。<code>conda update --all</code>，<code>conda list</code>，<code>conda install ...</code> のようにして管理する。パッケージは /opt/homebrew/Caskroom/miniforge/base/lib/python3.9/site-packages に入る。</p>

<p>miniforge + Apple の TensorFlow は <a href="https://github.com/apple/tensorflow_macos/issues/153">Instructions to install TensorFlow in a Conda Environment</a> のようにすれば実現できる。以下では apple という名前の環境を作る：</p>

<pre>
wget -N https://raw.githubusercontent.com/mwidjaja1/DSOnMacARM/main/environment.yml
conda env create --file=environment.yml --name=apple
conda init zsh
# .zshrc が書き変わるのでzshを再起動 (. ~/.zshrc)
# プロンプトの先頭に (base) が付く
conda activate apple
pip install --upgrade --force --no-dependencies \
    https://github.com/apple/tensorflow_macos/releases/download/v0.1alpha3/tensorflow_macos-0.1a3-cp38-cp38-macosx_11_0_arm64.whl
    https://github.com/apple/tensorflow_macos/releases/download/v0.1alpha3/tensorflow_addons_macos-0.1a3-cp38-cp38-macosx_11_0_arm64.whl

ipython

In [1]: import tensorflow as tf

In [2]: tf.__version__
Out[2]: '2.4.0-rc0'

In [3]: quit
conda deactivate
</pre>

<p><a href="https://pytorch.org">PyTorch</a> は miniforge の Python 3.9 に普通にインストールできるようだ。TensorflowのようなM1への最適化は<a href="https://github.com/pytorch/pytorch/issues/47702">要望</a>はあるがまだのようだ。</p>

<pre>
conda install pytorch torchvision  # torchaudio はまだダメ
</pre>

<h3>R</h3>

<p><a href="https://mac.r-project.org">R for macOS Developers</a> や <a href="https://rud.is/b/2021/02/07/fully-native-m1-apple-silicon-r-setup/">Fully Native M1/Apple Silicon R Setup</a> 参照。正式版は R 4.1.0 以降とのこと。</p>

<h3>TeX</h3>

<p><a href="https://tug.org/texlive/pretest.html">TeX Live 2021 pretest</a> が出た。Universal バイナリが含まれているようだ。以下は古い情報。</p>

<p>Rosetta で使っても十分速いが，native なコードを使いたければ，MacTeX の <a href="http://www.tug.org/mactex/aboutarm.html">About Arm</a> のページから <a href="http://www.tug.org/mactex/MacTeX-2020-Universal.pkg">MacTeX-2020-Universal.pkg</a> をダウンロードして展開して得られるバイナリで TeX Live 2020 のバイナリを置き換えればよい。例えば TeX Live 2020 が /usr/local/texlive/2020 にインストールされているなら次のようにすればよい。</p>

<pre>
pkgutil --expand MacTeX-2020-Universal.pkg /tmp/hoge
pax -rz -f /tmp/hoge/MacTeX-2020-Universal-Start.pkg/Payload
mv usr/local/texlive/2020/bin/custom /usr/local/texlive/2020/bin/
</pre>

<p>これで /usr/local/texlive/2020/bin/custom にパスを通す。</p>

<p>lualatex で188ページの原稿をコンパイルする時間（数回のうち最小値）：

<ul>
  <li>MacBook Air (M1, 2020) 16GB Rosetta 11.52秒 arm64 8.63秒</li>
  <li>Mac mini (2018) 16GB 16.221秒</li>
  <li>MacBook Air (11-inch, Early 2015) 8GB 21.614秒</li>
  <li>Mac mini (Late 2014) 8GB 22.514秒</li>
</ul>

<h3>VS Code</h3>

<p><a href="https://code.visualstudio.com">VS Code</a> はデフォルトで M1 Mac に対応した。</p>

<h3>X Window System</h3>

<p><a href="https://www.xquartz.org">XQuartz</a> は 2.8.0 beta1 以降で Apple Silicon をサポート。</p>

<h2>参考</h2>

<ul>
  <li>@shibukawa さんの <a href="https://qiita.com/shibukawa/items/797b7cbb7e530842e6f7">M1 Macの開発環境</a></li>
  <li>iori さんの <a href="https://zenn.dev/ioridev/articles/c74af379e4e73151790d">個人的 M1 mac 開発環境状況</a></li>
  <li>@yujiod さんの <a href="https://qiita.com/yujiod/items/56002a7cef5b5a3be3fb">Apple SiliconにおけるHomebrewのベストプラクティス</a></li>
  <li><a href="https://github.com/neurolabusc/AppleSiliconForNeuroimaging">Apple Silicon For Neuroimaging</a></li>
</ul>

<hr>

<footer>
<p><a href="../" rel="author">奥村 晴彦</a></p>

<p>
<!-- hhmts start -->
Last modified: <time>2021-03-21 20:45:16</time>
<!-- hhmts end -->
</p>
</footer>
</body>
</html>
