<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<title>M1 Mac</title>
<link rel="stylesheet" href="/~okumura/style6.css">
<link rel="license" href="http://creativecommons.org/licenses/by/4.0/">
</head>
<body>

<nav id="breadcrumbs" itemprop="breadcrumb">
<a href="../" rel="home">ホーム</a> &gt;
<a href="./">macOS</a> &gt;
</nav>

<h1>M1 Mac</h1>

<h3>はじめに</h3>

<p>2020-11-13 に Apple Store で注文した MacBook Air 16G/256G が 2020-11-29 に届いたのでさっそく設定。</p>

<p>2020-11-20 に生協に注文した Mac mini 16G/256G は 2021-01-12 に届いた。</p>

<p>どちらもメモリ16Gにしたが，通常は8Gで十分かも。SSDは満タンの半分程度で使うつもりで選ぶほうが安心。</p>

<h3>セットアップと一般的な設定</h3>

<p>他の Mac からコピーという手もあったが，ここはクリーンセットアップすることにする。Apple ID を設定したら iCloud から多くの設定を拾ってくれたので，たいした手間ではない。セットアップ中に「コンピュータアカウントを作成」でアカウント名が okumuraharuhiko とサジェストされるので okumura に直す（後でも直せる）。</p>

<p>まずは「システム環境設定」→「ソフトウェアアップデート」でOSをアップデート。「セキュリティとプライバシー」で FileVault をオンにする。</p>

<p>コンピュータ名が長ったらしいものになったのでシステム環境設定の「共有」で直す。ついでに「リモートログイン」を許可しておく（ssh でログインするため）。</p>

<p>Finder の環境設定→詳細で「すべてのファイル名拡張子を表示」をオンにする。Safari の環境設定「一般」で「ダウンロード後、“安全な”ファイルを開く」をオフにする。</p>

<p>メール設定では，表示→「メッセージ内のリモートコンテンツを読み込む」をオフに，作成→メッセージのフォーマットを「標準テキスト」に。</p>

<p>システム環境設定でキーボード→ショートカット→入力ソースのショートカットは Emacs に有害なので外す。キーボード→音声入力はデフォルトではControlキーを2回だが，これもControlキーを多用すると間違いやすいので，これ以外（例えばFnを2回）にする。ついでにキーリピートを最速にする（<a href="https://apple.stackexchange.com/questions/10467/how-to-increase-keyboard-key-repeat-rate-on-os-x">爆速にする方法</a>もある）。</p>

<p>コントロールセンターでキーボードの輝度をゼロに（MacBook Air）。</p>

<p>「システム環境設定」→「ディスプレイ」で正しい解像度が選べない場合は Option キーを押しながら「変更」をクリック（→ <a href="https://www.eizo.co.jp/support/compati/pc/mac/apple-m1/">Apple M1チップ搭載MacとEIZOモニターの互換性</a>）。</p>

<p>（これは好みだが）システム環境設定でディスプレイの色温度を自分好みに設定する。あるいは1日中 Night Shift に設定するのが簡単。</p>

<div class="note">
<p>以上以外に，私は非常に慎重を期すためにいつも自分を管理者から外している。具体的には，システム環境設定の「ユーザとグループ」で自分（奥村）以外に管理者（名前は例えば admin とする）を一人作成し，その管理者（Apple ID には紐付けない）でログインし直して奥村を一般ユーザに格下げする。これで何か重要なことをする際には管理者の名前とパスワードを聞いてくるのでうっかり危ないコマンドを実行する危険性が減る。Unix 的には sudoers から外したことに相当する。コマンドでシステム領域に触れたいときは <code>su admin</code> してから <code>sudo 何々</code> する。ただ，macOS はデフォルトでずいぶん安全になったので，今はここまでする必要はないかもしれない。</p>
</div>

<p>M1 Mac に残る問題（おそらく Big Sur 11.2 で改善されたはず）：</p>

<ul>
  <li>Bluetooth の接続がよく切れる</li>
  <li>スクリーンセーバー解除ができなくなる（他マシンからログインして ScreenSaverEngine を kill すればよい）</li>
  <li>Big Sur 11.2 になっても iPhone からの Bluetooth テザリングがうまくいかない（できたという人もいる）</li>
</ul>

<h3>ターミナル</h3>

<p>ターミナルを開き，試しに <code>uname -m</code> と打ち込むと arm64 と表示される。いったんターミナルを閉じて，Finder でターミナルを選択して「情報を見る」で「Rosettaを使用して開く」にチェックを付けると Rosetta がインストールされる（一般には任意の x86_64 なアプリを最初に起動したときに Rosetta がインストールされるのであろう）。Rosetta で開かれたターミナルに <code>uname -m</code> と打ち込むと x86_64 と表示される。今度は「Rosettaを使用して開く」をオフにしてターミナルを開き直して <code>uname -m</code> するとまた arm64 になるが，Rosetta がインストールされたので</p>

<pre>
arch -x86_64 uname -m
</pre>

<p>と打ち込むと x86_64 になる（Rosetta がない状態ではこのコマンドは Bad CPU type in executable エラーになる）。このようにちょっとしたコマンドなら <code>arch -x86_64</code> を冠することにより Rosetta で実行できるが，まとまったことをするには</p>

<pre>
arch -x86_64 zsh
</pre>

<p>とすれば Rosetta で zsh が立ち上がる。x86_64 のコードを実行するにはこの状態で行う。.zshrc に <code>alias x86='arch -x86_64 zsh'</code> のようにエイリアスを作っておけば <code>x86</code> と入力するだけでこの状態になる。</p>

<h3>シェル</h3>

<p>今まで bash を使っていたが，クリーンセットアップしたので zsh になった。とりあえずプロンプトを見やすくするために <code>~/.zshrc</code> に <code>PROMPT='%m:%~%# '</code> と書き込む。あるいは Rosetta 状態かどうかをプロンプトに含めてもよい：</p>

<pre>
ARCH=`uname -m`
PROMPT="${ARCH} %m:%~%# "
</pre>

<p>あるいは場合分けもできる：</p>

<pre>
ARCH=`uname -m`
if [[ $ARCH == 'arm64' ]]; then
    PROMPT="[a] %m:%~%# "
else
    PROMPT="[x] %m:%~%# "
fi
</pre>

<p>ほかに例えば次のようなオプションを設定しておく：</p>

<pre>
HISTFILE=~/.zsh_history
HISTSIZE=1000
SAVEHIST=1000
setopt HIST_VERIFY
setopt INC_APPEND_HISTORY
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_ALLOW_CLOBBER
setopt HIST_REDUCE_BLANKS
setopt HIST_IGNORE_SPACE
setopt NO_HIST_BEEP
setopt NO_CLOBBER
</pre>

<p>環境変数は <code>~/.zshenv</code> で設定するが，<code>NO_GLOBAL_RCS</code> オプションを指定しないと PATH を上書きされてしまう。</p>

<pre>
setopt NO_GLOBAL_RCS
export PATH=... # bashと同様
</pre>

<p>PATH は上記のように場合分けして設定する。</p>

<h3>Command Line Tools</h3>

<p>コマンドラインで開発する場合，巨大な Xcode をインストールする必要はない。コマンドライン用の開発ツールは，何らかの開発用コマンド（gcc とか python3 とか）を実行しようとするとインストールを促される。より確実な方法は，ターミナルに <code>xcode-select --install</code> と打ち込むか，<a href="https://developer.apple.com/downloads">https://developer.apple.com/downloads</a> からダウンロードしてインストールする。</p>

<h3>Homebrew</h3>

<p><a href="https://brew.sh/2021/02/05/homebrew-3.0.0/">Homebrew 3.0.0</a>:
"Apple Silicon is now officially supported for installations in /opt/homebrew."</p>

<p>wget，gnupg，pinentry-mac，imagemagick，poppler，ffmpeg，graphviz など，大部分のものは Apple Silicon 版が用意されるようになった。pandoc はまだ Intel 版だけ。</p>

<p>ARM 版は，<a href="https://docs.brew.sh/Installation">Installation</a> にあるように <code>/opt/homebrew</code>（ユーザ権限で書き込めるようにしておく）にインストールする：</p>

<pre>
cd /opt
curl -L https://github.com/Homebrew/brew/tarball/master | tar xz --strip 1 -C homebrew
</pre>

<p>ARM 版 Homebrew で <code>brew install emacs</code> でインストールされる emacs はターミナル版。<code>brew install --cask emacs</code> でインストールされるものは <a href="https://emacsformacosx.com">Emacs for Mac OS X</a> のバイナリで M1 用ではないが Rosetta で動く。</p>

<p>Rosetta で実行する Intel 版は通常通り <a href="https://brew.sh">Homebrew</a> の最初に書いてあるコマンドを <code>uname -m</code> が x86_64 なターミナルに打ち込めばインストールできる。</p>

<h3>Emacs 27</h3>

<p>arm64 環境でビルドしてみたがエラー。Rosetta 環境でなら簡単にできたので，現在はそれを使っている。ビルドが面倒な場合には適当なバイナリを探してくる。</p>

<h3>Python</h3>

<p>Apple のコマンドラインツールに入っている /usr/bin/python3 は universal binary な 3.8.2 である：</p>

<pre>
% file /usr/bin/python3
/usr/bin/python3: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64] [arm64e:Mach-O 64-bit executable arm64e]
/usr/bin/python3 (for architecture x86_64):	Mach-O 64-bit executable x86_64
/usr/bin/python3 (for architecture arm64e):	Mach-O 64-bit executable arm64e
</pre>

<p>これに Apple から提供されている <a href="https://github.com/apple/tensorflow_macos">tensorflow_macos</a> を入れれば Apple Silicon に最適化された TensorFlow とその依存するパッケージ群（numpy など）が入る。TensorFlow Blog の <a href="https://blog.tensorflow.org/2020/11/accelerating-tensorflow-performance-on-mac.html">Accelerating TensorFlow Performance on Mac</a> 参照。<a href="https://docs.python.org/3/tutorial/venv.html">venv</a> なので，bash 互換シェル（zsh でもよい）で <code>source ~/tensorflow_macos_venv/bin/activate</code> すると使えるようになり，<code>deactivate</code> で戻る。matplotlib や pandas は入らない。pip で入れようとしてもコンパイルでエラーになる。強者用である。</p>

<p>本家 <a href="https://www.python.org">python.org</a> の Python が 3.9.1 から universal バイナリも experimental という括弧書きで提供されるようになった。ただし pip で簡単にパッケージを追加できる状況にないので，混乱しないためには通常の macOS 64-bit Intel installer でインストールし，Rosetta で使うのが簡単である。インストールすると zsh を使っている場合は <code>.zprofile</code> に PATH が追記されるので適宜修正する。</p>

<p>一方，<a href="https://github.com/conda-forge/miniforge">miniforge</a> を使えば主要ライブラリを含めて arm64 版がインストールできる（<a href="https://qiita.com/syoyo/items/6ad890c8a902d02d8c5a">こちら</a>参照）。うまくすれば Apple の TensorFlow と組み合わせることもできる（<a href="https://towardsdatascience.com/tensorflow-2-4-on-apple-silicon-m1-installation-under-conda-environment-ba6de962b3b8">TensorFlow 2.4 on Apple Silicon M1: installation under Conda environment</a> および <a href="https://towardsdatascience.com/benchmark-m1-vs-xeon-vs-core-i5-vs-k80-and-t4-e3802f27421c">Benchmark M1 vs Xeon vs Core i5 vs K80 and T4</a> 参照）。</p>

<p>miniforge は Homebrew で入れるのが簡単。<code>/opt/homebrew/bin/brew install miniforge</code> とすればよい。/opt/homebrew/Caskroom/miniforge 以下に入るので /opt/homebrew/Caskroom/miniforge/base/bin をPATHに加える。<code>conda update --all</code>，<code>conda list</code>，<code>conda install ...</code> のようにして管理する。パッケージは /opt/homebrew/Caskroom/miniforge/base/lib/python3.9/site-packages に入る。</p>

<p><del>ただ，<code>ipython --matplotlib</code> と打ち込んだだけで bus error で落ちてしまった。通常のコードは実行できるし，<code>ipython --simple-prompt --matplotlib</code> なら落ちないので，UI がらみか。</del> ← 直った。</p>

<h3>R</h3>

<p><a href="https://rud.is/b/2021/02/07/fully-native-m1-apple-silicon-r-setup/">Fully Native M1/Apple Silicon R Setup</a> のようにすれば arm64 版 R ができるとのこと。</p>

<p><del><a href="https://www.r-project.org">R</a> は今のところ arm64 対応していない（<a href="https://developer.r-project.org/Blog/public/2020/11/02/will-r-work-on-apple-silicon/">Will R Work on Apple Silicon?</a> 参照）。まずは Fortran 90 compiler が必要とのこと。</del></p>

<h3>TeX</h3>

<p>Rosetta で使っても十分速いが，native なコードを使いたければ，MacTeX の <a href="http://www.tug.org/mactex/aboutarm.html">About Arm</a> のページから <a href="http://www.tug.org/mactex/MacTeX-2020-Universal.pkg">MacTeX-2020-Universal.pkg</a> をダウンロードして展開して得られるバイナリで TeX Live 2020 のバイナリを置き換えればよい。例えば TeX Live 2020 が /usr/local/texlive/2020 にインストールされているなら次のようにすればよい。</p>

<pre>
pkgutil --expand MacTeX-2020-Universal.pkg /tmp/hoge
pax -rz -f /tmp/hoge/MacTeX-2020-Universal-Start.pkg/Payload
mv usr/local/texlive/2020/bin/custom /usr/local/texlive/2020/bin/
</pre>

<p>これで /usr/local/texlive/2020/bin/custom にパスを通す。</p>

<p>lualatex で188ページの原稿をコンパイルする時間（数回のうち最小値）：

<ul>
  <li>MacBook Air (M1, 2020) 16GB Rosetta 11.52秒 arm64 8.63秒</li>
  <li>Mac mini (2018) 16GB 16.221秒</li>
  <li>MacBook Air (11-inch, Early 2015) 8GB 21.614秒</li>
  <li>Mac mini (Late 2014) 8GB 22.514秒</li>
</ul>

<h3>VS Code</h3>

<p><a href="https://code.visualstudio.com/download">Download Visual Studio Code</a> からダウンロードできる Mac 版は Intel 用。<a href="https://code.visualstudio.com/insiders/">Download Visual Studio Code Insiders</a> で ARM64 をクリックすれば ARM 版が入る。</p>

<h3>X Window System</h3>

<p><a href="https://www.xquartz.org/releases/index.html">XQuartz 2.8.0 beta1</a> で Apple Silicon をサポート。</p>

<h2>参考</h2>

<ul>
  <li>@shibukawa さんの <a href="https://qiita.com/shibukawa/items/797b7cbb7e530842e6f7">M1 Macの開発環境</a></li>
  <li>iori さんの <a href="https://zenn.dev/ioridev/articles/c74af379e4e73151790d">個人的 M1 mac 開発環境状況</a></li>
  <li>@yujiod さんの <a href="https://qiita.com/yujiod/items/56002a7cef5b5a3be3fb">Apple SiliconにおけるHomebrewのベストプラクティス</a></li>
  <li><a href="https://github.com/neurolabusc/AppleSiliconForNeuroimaging">Apple Silicon For Neuroimaging</a></li>
</ul>

<hr>

<footer>
<p><a href="../" rel="author">奥村 晴彦</a></p>

<p>
<!-- hhmts start -->
Last modified: <time>2021-02-08 13:56:49</time>
<!-- hhmts end -->
</p>
</footer>
</body>
</html>
