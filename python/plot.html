<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<title>プロット</title>
<link rel="stylesheet" href="style.css">
<link rel="license" href="http://creativecommons.org/licenses/by/4.0/">
</head>
<body>

<nav id="breadcrumbs">
<a href="/~okumura/">ホーム</a> &gt;
<a href="./">Python</a> &gt;
</nav>

<h1>プロット</h1>

<h2>matplotlib</h2>

<p>プロット（グラフ描画）には <a href="https://matplotlib.org/">matplotlib</a>（マットプロットリブ）という MATLAB ライクなライブラリを使います。</p>

<p>もし，例えば</p>

<pre>
import matplotlib.pyplot as plt

plt.plot([-1,1])
plt.show()
</pre>

<p>でエラーになるなら，<code>~/.matplotlib/matplotlibrc</code> の<a href="https://matplotlib.org/faq/usage_faq.html#what-is-a-backend">バックエンド</a>の指定を見直します。Macの場合は</p>

<pre>
backend: MacOSX
</pre>

<p>または <code>pip install PyQt5</code> して</p>

<pre>
backend: Qt5Agg
</pre>

<p>とします（うまくいかなければ <code>MacOSX Qt5Agg Qt4Agg Gtk3Agg GTK3Cairo TkAgg WxAgg Agg Cairo</code> の中から選んでください）。</p>

<p>デフォルトのフォントでは日本語が出ません。日本語を出したいなら，システムにインストールされている適当な TrueType または OpenType フォント名を <code>~/.matplotlib/matplotlibrc</code> に書き加えます。Macなら例えば</p>

<pre>
font.family: AppleGothic
</pre>

<p>でよさそうです。あるいは，<a href="https://ipafont.ipa.go.jp">こちら</a>から IPAex ゴシックをいただいてきてシステムにインストールし，次のように書き加えます：</p>

<pre>
font.family: IPAexGothic
</pre>

<p>新しいフォントをインストールしたら，フォント名のキャッシュ <code>~/.matplotlib/font*</code> は消します（次回 matplotlib 使用の際に自動生成されます）。</p>

<p>matplotlib 3.1.0 以降は TrueType Collection も表示できるようになりましたので，Windows なら</p>

<pre>
font.family: MS Gothic
</pre>

<p>でもかまいません。ただ，TrueType Collection では PDF への保存ができないようです。</p>

<p>なお，<code>font.family</code> のデフォルト値は <code>sans-serif</code> で，DejaVu Sans が使われます。<code>serif</code> と指定すれば DejaVu Serif になります。DejaVu は Bitstream Vera ベースの良質なフォントです。</p>

<p>PDF で保存する場合，TrueType フォントは Type 3 形式でサブセット埋め込みされます。OpenType の Source Han Sans などは，日本語表示には使えますが，サブセット化できず，丸ごと埋め込まれてしまい，PDF のファイルサイズが巨大になります。また，今のところ，TrueType Collection は PDF 保存に対応していないようです。</p>

<div class="note">
<p><code>~/.matplotlib/matplotlibrc</code> を作る前の，システムの <code>matplotlibrc</code> の位置は，ターミナルに次のコマンドを打ち込めば表示されます：</p>
<pre>
python3 -c "import matplotlib; print(matplotlib.matplotlib_fname())"
</pre>
</div>

<div class="note">
<p>OpenType の例えば Source Han Sans を使いたければ，いったん</p>
<pre>
plt.rcParams['font.family'] = 'Source Han Sans'
plt.savefig('filename.svg', bbox_inches="tight")
</pre>
<p>で SVG 形式に保存してから，<code>rsvg-convert</code> コマンド（Mac では <code>brew install librsvg</code>，CentOS 7 では <code>yum install librsvg2-tools</code> で入る）を使ってターミナルで</p>
<pre>
rsvg-convert --format=pdf --output=filename.pdf filename.svg
</pre>
<p>で変換できます。文字はアウトライン化され，文字情報はなくなります。別の方法として，後述の PGF 経由で出力する方法があります。そちらの方法なら文字情報が保たれます。</p>
</div>

<p>簡単なプロットで試してみましょう。ターミナルで IPython を使うなら <code>ipython --matplotlib</code> として起動します（<code>--matplotlib</code> はデフォルトでオンになっている環境もあります）。Jupyter Notebook の環境なら</p>

<pre>
%matplotlib inline
</pre>

<p>という1行をまず打ち込みます。そして，次のように打ち込みます：</p>

<pre>
import matplotlib.pyplot as plt

plt.plot([-1,1])
plt.title('日本語タイトル')
</pre>

<p>これでもしグラフが出ないなら <code>plt.show()</code> と打ち込みます。日本語タイトルも軸のマイナスも化けずに出れば合格です。もし日本語が出てもマイナスが化ける場合は，フォントに MINUS SIGN (U+2212) がないのでしょう。マイナスを HYPHEN-MINUS (U+002D) で代用するために <code>~/.matplotlib/matplotlibrc</code> に次の1行を追加します：</p>

<pre>
axes.unicode_minus: False
</pre>

<p>環境によっては，<code>plt.show()</code> でグラフが出ても，グラフの窓を閉じない限り，次に進めなくなります。この状態を「ブロック」といいます。ブロックしないようにするには <code>plt.show(block=False)</code> のようにオプションを付けます。対話型環境でないスクリプト中でこれをすると，グラフがすぐ消えてしまいます。</p>

<p>現在のプロットの中身をクリアするのは <code>plt.clf()</code>，最後に描いたプロットを消すのは <code>plt.close()</code> です。全部のプロットを消すには <code>plt.close("all")</code> とします。</p>

<p>IPython では，詳しいヘルプは例えば <code>?plt.plot</code> のように打ち込めば現れます。</p>

<p>プロットのスタイルはいろいろ選べます。例えば</p>

<pre>
plt.style.use('ggplot')
</pre>

<p>とすれば R の ggplot のスタイルになります。スタイルは <code>plt.style.available</code> で一覧できます。もっと細かい設定は <code>plt.rcParams</code> と打ち込めば一覧できます。フォントも</p>

<pre>
plt.rcParams['font.family'] = 'IPAexGothic'
plt.rcParams['font.size'] = 12
</pre>

<p>あるいは同じことですが</p>

<pre>
plt.rc('font', 'family'='IPAexGothic', 'size'=12)
</pre>

<p>のようにして変更できます。デフォルト状態に戻すには <code>plt.rcdefaults()</code> と打ちます。</p>

<p>タイトルやラベルに日本語のフォントを使う程度なら，特にデフォルトのフォントを変えなくても，次のように関数にオプションで与えることもできます：</p>

<pre>
plt.title('日本語タイトル', fontfamily='IPAexGothic', fontsize=20)
plt.xlabel('日本語のx軸タイトル', fontfamily='IPAexGothic')
</pre>

<div class="note">
<p>より簡単な方法として <code>japanize-matplotlib</code> をインストールして <code>import japanize_matplotlib</code> する方法があります（<a href="https://qiita.com/uehara1414/items/6286590d2e1ffbf68f6c">pip install して import するだけで matplotlib を日本語表示対応させる</a>参照）。Google Colaboratory などリモートの環境で日本語を表示するときに便利です。</p>
<pre>
!pip install japanize-matplotlib

import matplotlib.pyplot as plt
import japanize_matplotlib
plt.plot([1,2])
plt.title('日本語タイトル')
</pre>
</div>

<h2>ファイルへの保存</h2>

<p>ファイルへの保存は，メニューからも，プログラムでもできます。アクティブなプロット（最後に描いたプロット）を保存しますので，例えば「Figure 2」を保存したいなら，あらかじめ <code>plt.figure(2)</code> と打ち込んでアクティブにしておきます：</p>

<pre>
plt.savefig('filename.png', bbox_inches="tight")  # デフォルト: dpi=100
plt.savefig('filename.pdf', bbox_inches="tight")
plt.savefig('filename.svg', bbox_inches="tight")
plt.savefig('filename.pgf', bbox_inches="tight")
</pre>

<p>最後のPGF（Portable Graphics Format）はTeXのTi<i>k</i>Zのベースとなるグラフィック言語です。これは次のような形のLaTeXファイルを <code>xelatex</code> か <code>lualatex</code> でコンパイルすることによってPDFに変換できます：</p>

<pre>
\documentclass{standalone}
\usepackage{pgf}
\usepackage{fontspec}
\begin{document}
\input{filename.pgf}
\end{document}
</pre>

<p>PDFの場合は，次のようにすることもできます：</p>

<pre>
from matplotlib.backends.backend_pdf import PdfPages

with PdfPages('foo.pdf') as pdf:
    # ここで図を描く
    pdf.savefig(fig)
</pre>

<h2>文字だけLaTeXを使う</h2>

<p>軸の文字やタイトル・キャプションなどの数式は，LaTeX風に <code>$</code> で囲んで書けば，ちゃんと解釈してくれます。その際に，文字列は <code>r'...'</code> のように <code>r</code> を付けて書けば，<code>\</code> を特別扱いしない「生の」（raw）文字列として扱われます。</p>

<p><code>latex</code>，<code>dvipng</code>，<code>dvips</code>，<code>gs</code> コマンドが使える環境では，次のように <code>text.usetex</code> を <code>True</code> にすれば，本当に文字部分だけLaTeXを起動して，きれいな出力を得ることができます。</p>

<pre>
import matplotlib.pyplot as plt
import numpy as np

plt.rcParams['text.usetex'] = True

x = np.linspace(-5, 5, 101)
y = 1 / (1 + np.exp(-x))
plt.figure(figsize=(5, 3))
plt.plot(x, y, 'k')
plt.xlabel(r'$x$')
plt.ylabel(r'$y$')
plt.title("Sigmoid Function")
plt.legend([r'$y = \frac{1}{1+e^{-x}}$'])
plt.savefig("sigmoid.pdf", bbox_inches="tight")
</pre>

<p>デフォルトではComputer Modernフォント（数式はcmrやcmmi，タイトルはcmss）になります（PDFにはフォントがType 1形式で埋め込まれます）が，次のようにしてフォントを指定できます：</p>

<pre>
plt.rcParams['font.family'] = 'serif' # あるいは 'sans-serif' など
plt.rcParams['font.serif'] = 'times'  # あるいは 'palatino' など
plt.rcParams['font.sans-serif'] = 'helvetica'
</pre>

<p>Timesでは <code>\usepackage{mathptmx}</code>，Palatinoでは <code>\usepackage{mathpazo}</code>，Helveticaでは <code>\usepackage{helvet}</code> がプリアンブルに書き込まれます。実際に処理されるLaTeXファイルは例えば次のようになります：</p>

<pre>
\documentclass{article}
\usepackage{type1cm}
\usepackage{mathpazo} % Palatino指定で入る
\usepackage{helvet}   % Helvetica指定で入る
\usepackage{textcomp}
\usepackage[utf8]{inputenc}
% ここに別途指定したプリアンブルが入る
\usepackage[papersize={72in,72in},body={70in,70in},margin={1in,1in}]{geometry}
\pagestyle{empty}
\begin{document}
\fontsize{10.000000}{12.500000}{\rmfamily $y = \frac{1}{1+e^{-x}}$}
\end{document}
</pre>

<p>次のようにしてプリアンブルを直接指定することもできます：</p>

<pre>
plt.rcParams['text.latex.preamble'] = r'\usepackage{tgtermes},\usepackage{newtxmath}'
</pre>

<p>プリアンブルを指定する場合は，他のコードと衝突してエラーにならないように，十分注意が必要です。上の例では，<code>\usepackage{newtxtext}</code> を指定するとエラーになったので，<code>\usepackage{tgtermes}</code> にしました。</p>

<p><code>~/.matplotlib/tex.cache</code> にLaTeXファイルやdviファイルがたくさんできます。消してもかまいませんが，同じ文字列が出てきたら再利用されますので，特に消す必要はありません。</p>

<h2>その他</h2>

<p>図の大きさを指定する：</p>

<pre>
plt.figure(figsize=[6.4, 4.8])  # デフォルトは6.4×4.8インチ
</pre>

<p>あるいはデフォルトを変更する：</p>

<pre>
plt.rcParams['figure.figsize'] = (6.4, 4.8)
</pre>

<p>（Jupyter Notebook などの場合）図を PNG でなく SVG にする（拡大しても荒くならない）：</p>

<pre>
from IPython import display
display.set_matplotlib_formats('svg')
</pre>

<p>軸の最小値・最大値を指定する：</p>

<pre>
plt.xlim(最小値,最大値)
plt.ylim(最小値,最大値)
</pre>

<p>軸の目盛位置と目盛ラベルを指定する：</p>

<pre>
plt.xticks([-np.pi,0,np.pi], [r'$-\pi$','$0$',r'$\pi$'])
</pre>

<p>対数目盛：</p>

<pre>
plt.xscale('log')
plt.yscale('log')
</pre>

<p>グリッド描画：</p>

<pre>
plt.grid()
</pre>

<p>どちらかの軸の範囲を拡大して両軸の目盛を等しくする：</p>

<pre>
plt.axis('equal')
</pre>

<p>プロット領域の縦横比を調節して両軸の目盛を等しくする：</p>

<pre>
plt.axis('scaled')
</pre>

<p>水平線，垂直線を引く：</p>

<pre>
plt.axhline()  # 引数を省略すればy=0の水平線
plt.axvline()  # 引数を省略すればx=0の水平線
plt.axhline(0.5, linewidth=1, color="black")
</pre>

<p>プロットをクリア：</p>

<pre>
plt.clf()
</pre>

<p>全プロットを閉じる：</p>

<pre>
plt.close("all")
</pre>

<h2>参考</h2>

<ul>
  <li><a href="https://matplotlib.org/api/colors_api.html">色</a></li>
  <li><a href="https://matplotlib.org/api/markers_api.html">マーカー一覧</a></li>
  <li>JAMSTEC山下陽介さんの<a href="http://ebcrpa.jamstec.go.jp/~yyousuke/matplotlib/index.html">気象データ解析のためのmatplotlibの使い⽅</a></li>
</ul>

<hr>

<p><a href="../" rel="author">奥村 晴彦</a></p>

<p>
<!-- hhmts start -->
Last modified: <time>2020-01-21 13:47:18</time>
<!-- hhmts end -->
</p>
</body>
</html>
